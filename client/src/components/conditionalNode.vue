<template>
    <div  ref="root">
        <div>Node {{nodeId}}</div>
        <div>Conditional node</div>
        <div style="margin-bottom:10px;">
            <select @change="handleOptionChange" v-model="logicOperator">
            <option value="Greater than">Greater than</option>
            <option value="Lesser than">Lesser than</option>
            <option value="Equal than">Equal than</option>
        </select>
        </div>
        <button @click="handleClickMain">Enter main code block</button>
        <button @click="handleClickElse">Enter else code block</button>
        <div>{{conditionMet}}</div>
        
    </div>
</template>

<script>
import { defineComponent, nextTick, onMounted,ref,getCurrentInstance, readonly} from 'vue'
import handleModule from './handleModule.js';
import setExecProcedure from './setExecProcedure.js';
import useEmitter from './useEmitter.js';


export default defineComponent({
    setup() {
       
        const root = ref(null);
        const logicDict = readonly({
            'Greater than' : '>',
            'Lesser than' : '<',
            'Equal than' : '=='
        })
        const nodeId = ref(0);
        const nodeData = ref({})
        const conditionMet = ref(null)
        const logicOperator = ref('')
       
        const emitter = useEmitter()
        let df = getCurrentInstance().appContext.config.globalProperties.$df.value

        onMounted(async () => {
           await nextTick()
            nodeId.value = root.value.parentElement.parentElement.id.slice(5)
            nodeData.value = df.getNodeFromId(nodeId.value)
            logicOperator.value = nodeData.value.data.logicOperator
            if(df.drawflow.drawflow[`conditional-main-block-${nodeId.value}`] === undefined)
            {
                df.addModule(`conditional-main-block-${nodeId.value}`)
            }
            if(df.drawflow.drawflow[`conditional-else-block-${nodeId.value}`] === undefined)
            {
                df.addModule(`conditional-else-block-${nodeId.value}`)
            }

            setExecProcedure(emitter,executeNode,df,nodeId)

            

        })

        function handleClickMain()
        {
            df.changeModule(`conditional-main-block-${nodeId.value}`)
        }
        function handleClickElse()
        {
            df.changeModule(`conditional-else-block-${nodeId.value}`)
        }

        function handleOptionChange()
        {
            nodeData.value.data.logicOperator = logicOperator.value
            df.updateNodeDataFromId(nodeId.value,nodeData.value.data)
        }

        function executeNode()
        {
            const moduleName = df.getModuleFromNodeId(nodeId.value)
            if(!handleModule(moduleName,df))
            {
                return;
            }
            nodeData.value = df.getNodeFromId(nodeId.value)
            const comparisonValues = []
            const comparisonItemExpressions = []

            Object.keys(nodeData.value.inputs).forEach(key => {
                const nodeConnectedId = nodeData.value.inputs[key].connections[0].node
                const nodeConnected = df.getNodeFromId(nodeConnectedId)

                if(nodeConnected.name==='useVariableNode')
                {
                    console.log(nodeConnected.data.pythonCode)
                }
                comparisonItemExpressions.push(nodeConnected.data.pythonCode)
                comparisonValues.push(nodeConnected.data.result)

            })

            switch(logicOperator.value)
            {
                case 'Greater than':
                    conditionMet.value = comparisonValues[0] > comparisonValues[1]
                break;
                case 'Lesser than':
                    conditionMet.value = comparisonValues[0] < comparisonValues[1]
                break;
                case 'Equal than':
                    conditionMet.value = comparisonValues[0] === comparisonValues[1]
                break;
            }
            
            nodeData.value.data.terms = [comparisonItemExpressions[0],logicDict[logicOperator.value],comparisonItemExpressions[1]]
            nodeData.value.data.pythonCode = `if ${comparisonItemExpressions[0]} ${logicDict[logicOperator.value]} ${comparisonItemExpressions[1]}:`

            df.updateNodeDataFromId(nodeId.value,nodeData.value.data)
        }

        return{
            root,
            handleClickMain,
            conditionMet,
            logicOperator,
            handleClickElse,
            handleOptionChange,
            nodeId
        }   
    },
})
</script>

<style scoped>

    .static{
        padding:20px;
        background-color:none;
    }
    .isFalse{
        background-color:red;
    }

    .isTrue{
        background-color:green;
    }

</style>